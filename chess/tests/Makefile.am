## Process this file with automake to produce Makefile.in

SUBDIRS = sparsematrix

EXTRA_DIST = test-smatmul.ref.yaml mat_114_8986.dat  mat_1202_77462.dat  mat_600_33620.dat tols.yaml

check_PROGRAMS = smatmul

AM_FCFLAGS = -I$(top_builddir)/includes -I. @LIB_FUTILE_CFLAGS@ @LIBETSFIO_INCLUDE@ @MPI_INCLUDE@
AM_LDFLAGS = -L$(top_builddir)/src
if BUILD_DYNAMIC_LIBS
AM_LDFLAGS += -Wl,-rpath=$(abs_top_builddir)/src -Wl,-rpath=$(DESTDIR)$(libdir)
chess_library = $(top_builddir)/src/libCheSS-1.so.@CHESS_MINOR_VERSION@
else
chess_library = $(top_builddir)/src/libCheSS-1.a @LIB_CHESS_DEPS@
endif

smatmul_SOURCES = smatmul.f90
smatmul_LDADD = $(chess_library) @LINALG_LIBS@
if BUILD_DYNAMIC_LIBS
smatmul_LDADD += @LIB_FUTILE_LIBS@
endif

CLEANFILES = *.txt *.yaml report

test-smatmul.out.yaml: smatmul
	cp -f $(srcdir)/mat_114_8986.dat $(PWD)/matrix.txt
	$(run_parallel) ./smatmul --filename=matrix.txt --nit=10 > test-smatmul.out.yaml
	cp -f $(srcdir)/mat_600_33620.dat $(PWD)/matrix.txt
	$(run_parallel) ./smatmul --filename=matrix.txt --nit=100 --verbosity=1 >> test-smatmul.out.yaml
	cp -f $(srcdir)/mat_1202_77462.dat  $(PWD)/matrix.txt
	$(run_parallel) ./smatmul --filename=matrix.txt --nit=20 --verbosity=1 >> test-smatmul.out.yaml


check: report test-smatmul.out.yaml
	python $(pythondir)/fldiff_yaml.py \
		-r $(abs_srcdir)/test-smatmul.ref.yaml -d test-smatmul.out.yaml -t $(abs_srcdir)/tols.yaml \
	        --output fldiff.report.yaml


report:
	@if test $(MAKELEVEL) = 0 ; then python $(pythondir)/report.py ; fi
